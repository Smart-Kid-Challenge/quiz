<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tech Tigers Mock Test</title>
  <link rel="stylesheet" href="css/all.css">
</head>
<body>

  <div class="container">

    <div class="user-info">
      👋 Xin chào, <span id="student-name">bạn nhỏ</span>!
    </div>

    <!-- LOGO FOCUS LEARNING -->
    <div class="header-centered">
      <img src="image/logolv.jpg" alt="Focus Learning Logo" class="logo-absolute">
      <h1>📝 Tech Tigers Mock Test</h1>
    </div>

    <!-- Bài thi -->
    <div>

      <h2>🧠 Part 1: Vocabulary</h2>

      <div class="question">
        <p>1. How old is he?</p>
        <label><input type="radio" name="q3" value="a"> a. He 35 years old.</label>
        <label><input type="radio" name="q3" value="b"> b. His 35 years old.</label>
        <label><input type="radio" name="q3" value="c"> c. He’s 35 years old.</label>
      </div>

      <div class="question">
        <p>2. March is the third _____ of the year.</p>
        <label><input type="radio" name="q4" value="a"> a. month</label>
        <label><input type="radio" name="q4" value="b"> b. day</label>
        <label><input type="radio" name="q4" value="c"> c. season</label>
      </div>

      <div class="question">
        <p>3. How much is this T-shirt?</p>
        <label><input type="radio" name="q13" value="a"> a. They’re $12.</label>
        <label><input type="radio" name="q13" value="b"> b. Is $12.</label>
        <label><input type="radio" name="q13" value="c"> c. It’s $12.</label>
      </div>

      <div class="question">
        <p>4. I bought new shoes _____ weekend.</p>
        <label><input type="radio" name="q20" value="a"> a. just</label>
        <label><input type="radio" name="q20" value="b"> b. ago</label>
        <label><input type="radio" name="q20" value="c"> c. last</label>
      </div>

      <div class="question">
        <p>5. A: How do I get to the park? B: _____ Main Street.</p>
        <label><input type="radio" name="q26" value="a"> a. In front of</label>
        <label><input type="radio" name="q26" value="b"> b. Turn left</label>
        <label><input type="radio" name="q26" value="c"> c. Go straight down</label>
      </div>

      <h2>🔧 Part 2: Grammar</h2>

      <div class="question">
        <p>1. Is Jenny in the living room?</p>
        <label><input type="radio" name="q5" value="a"> a. Yes, they are.</label>
        <label><input type="radio" name="q5" value="b"> b. Yes, it is.</label>
        <label><input type="radio" name="q5" value="c"> c. No, she isn’t.</label>
      </div>

      <div class="question">
        <p>2. What time does she get up?</p>
        <label><input type="radio" name="q11" value="a"> a. She always get up at 7 o’clock.</label>
        <label><input type="radio" name="q11" value="b"> b. She always gets up at 7 o’clock.</label>
        <label><input type="radio" name="q11" value="c"> c. She always getting up at 7 o’clock.</label>
      </div>

      <div class="question">
        <p>3. What are you doing?</p>
        <label><input type="radio" name="q14" value="a"> a. I’m taking a test.</label>
        <label><input type="radio" name="q14" value="b"> b. I take a test.</label>
        <label><input type="radio" name="q14" value="c"> c. I’m take a test.</label>
      </div>

      <div class="question">
        <p>4. He thinks that dogs are _____ than cats.</p>
        <label><input type="radio" name="q22" value="a"> a. friendliest</label>
        <label><input type="radio" name="q22" value="b"> b. friendly</label>
        <label><input type="radio" name="q22" value="c"> c. friendlier</label>
      </div>

      <div class="question">
        <p>5. The new vaccine _____ to be highly effective against the virus.</p>
        <label><input type="radio" name="q24" value="a"> a. is believed</label>
        <label><input type="radio" name="q24" value="b"> b. was believing</label>
        <label><input type="radio" name="q24" value="c"> c. has believed</label>
      </div>

      <h2>✍️ Part 3: Writing</h2>
      <h3>I. Hoàn thành câu</h3>

      <div class="question">
        <p>1. Yesterday, Tom _____ (3) soccer with his friends in the park.<br>
          They _____ (4) playing when it suddenly rained!</p>
        <input type="text" name="wI2_1" placeholder="Động từ (3)..." style="margin-bottom: 10px; width: 100%;">
        <input type="text" name="wI2_2" placeholder="Động từ (4)..." style="width: 100%;">
      </div>

      <div class="question">
        <p>2. Tom _____ (7) like vegetables, but he loves fruit.<br>
          His mom says, 'If you eat veggies, you _____ (8) stronger!'</p>
        <input type="text" name="wI4_1" placeholder="Động từ (7)..." style="margin-bottom: 10px; width: 100%;">
        <input type="text" name="wI4_2" placeholder="Động từ (8)..." style="width: 100%;">
      </div>

      <h3>II. Viết lại câu đúng</h3>

      <div class="question">
        <p>1. use / you / Did / have / to / computer / desktop / a</p>
        <input type="text" name="wII6" placeholder="Viết lại câu đúng...">
      </div>

      <div class="question">
        <p>2. studied / have / for / I / years / English / three</p>
        <input type="text" name="wII7" placeholder="Viết lại câu đúng...">
      </div>

      <div class="question">
        <p>3. listening / like / you / Do / music / to</p>
        <input type="text" name="wII10" placeholder="Viết lại câu đúng...">
      </div>

      <button onclick="submitTest()">✅ Nộp bài</button>
      <div id="result-message" style="margin-top: 20px; font-size: 18px; color: green; text-align: center;"></div>

      <div id="loading" style="display:none; text-align:center; margin-top:15px; color:blue; font-weight:bold;">
        ⏳ Đang xử lý bài làm của bạn...
      </div>


    </div>
  </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // Gán tên học sinh vào giao diện khi tải trang
  window.addEventListener("DOMContentLoaded", () => {
    const studentName = localStorage.getItem('studentName');
    if (studentName) {
      document.getElementById("student-name").textContent = studentName;
    }
  });

  function submitTest() {
    const radioQuestions = ["q3", "q4", "q13", "q20", "q26", "q5", "q11", "q14", "q22", "q24"];
    const textInputs = ["wI2_1", "wI2_2", "wI4_1", "wI4_2", "wII6", "wII7", "wII10"];

    // 1. Kiểm tra hoàn thành
    for (let name of radioQuestions) {
        if (!document.querySelector(`input[name="${name}"]:checked`)) {
            alert("⚠️ Vui lòng hoàn thành tất cả các câu trắc nghiệm trước khi nộp bài.");
            return;
        }
    }
    for (let name of textInputs) {
        const input = document.querySelector(`input[name="${name}"]`);
        if (!input || input.value.trim() === "") {
            alert("⚠️ Vui lòng hoàn thành tất cả các câu tự luận trước khi nộp bài.");
            return;
        }
    }

    // 🔄 Hiện loading, vô hiệu hóa nút
    document.querySelector("button").disabled = true;
    document.getElementById("loading").style.display = "block";

    // 2. Đáp án trắc nghiệm
    const answerKey = {
        q3: "c", q4: "a", q13: "c", q20: "c", q26: "c",
        q5: "c", q11: "b", q14: "a", q22: "c", q24: "a"
    };

    // 3. Đáp án viết
    const writingAnswers = {
        wI2_1: ["played"],
        wI2_2: ["were"],
        wI4_1: ["doesn't", "does not"],
        wI4_2: ["will be"],
        wII6: ["did you use to have a desktop computer", "did you use to have a desktop computer?"],
        wII7: ["i have studied english for three years"],
        wII10: ["do you like listening to music", "do you like listening to music?"]
    };

    // 4. Tính điểm trắc nghiệm
    let correctTracNghiem = 0;
    for (const name of radioQuestions) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        if (selected && selected.value === answerKey[name]) correctTracNghiem++;
    }

    // 5. Tính điểm phần viết
    let correctViet = 0;
    for (const key in writingAnswers) {
        const input = document.querySelector(`input[name="${key}"]`);
        const userAnswer = input.value.trim().toLowerCase();
        const valids = writingAnswers[key].map(a => a.toLowerCase());
        if (valids.includes(userAnswer)) correctViet++;
    }

    const totalScoreNumeric = correctTracNghiem + correctViet;
    const totalQuestions = radioQuestions.length + Object.keys(writingAnswers).length;
    const scoreText = `${totalScoreNumeric}/${totalQuestions}`;

    // 6. Lấy thông tin học sinh
    const studentName = localStorage.getItem("studentName") || "Không rõ";
    const birthYear = localStorage.getItem("birthYear") || "Không rõ";
    const parentPhone = localStorage.getItem("parentPhone") || "Không rõ";
    const submitTime = new Date().toLocaleString();

    // 7. Gửi dữ liệu bằng FormData
    const formData = new FormData();
    formData.append("name", studentName);
    formData.append("birthYear", birthYear);
    formData.append("parentPhone", parentPhone);
    formData.append("score_text", scoreText);
    formData.append("score_tracnghiem", correctTracNghiem);
    formData.append("score_viet", correctViet);

    fetch("https://script.google.com/macros/s/AKfycbxOWFlyaT6xZH9f28quUTX-wxhWskAzqYJV8Qyv7B9N95D6ZMdcPYCI04S1h3YdF1yq/exec", {
        method: "POST",
        body: formData
    })
    .then((res) => res.json())
    .then((data) => {
        console.log("✅ Dữ liệu đã gửi:", data);

        // Lưu điểm vào localStorage
        localStorage.setItem("finalScoreText", scoreText);
        localStorage.setItem("finalScoreNumeric", totalScoreNumeric.toString());
        localStorage.setItem("totalQuestions", totalQuestions.toString());

        // Chuyển trang khi gửi thành công
        window.location.href = "result.html";
    })
    .catch((err) => {
        console.error("❌ Lỗi gửi dữ liệu:", err);
        alert("❌ Gửi dữ liệu thất bại. Vui lòng kiểm tra kết nối mạng và thử lại.");
        // 🔁 Bỏ chặn nút và ẩn loading nếu lỗi
        document.querySelector("button").disabled = false;
        document.getElementById("loading").style.display = "none";
    });
}


</script>

</body>
</html>
