<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/all.css">
</head>
<body>

  <div class="container">
    <div class="header-centered">
      <img src="image/logolv.jpg" alt="Logo" class="logo-absolute">
      <h1>📊 Kết quả bài thi</h1>
    </div>

    <div id="loading-message">⏳ Đang tải dữ liệu, vui lòng đợi...</div>

    <div id="results-table"></div>

    <div id="admin-content">
      <div id="results-table"></div>
      <button onclick="logout()">🚪 Đăng xuất</button>
    </div>
  </div>

  <script>
    // BƯỚC 1: Kiểm tra quyền admin
    if (localStorage.getItem("isAdmin") !== "true") {
      alert("⚠️ Bạn cần đăng nhập để truy cập.");
      window.location.href = "admin_login.html";
    }

    // BƯỚC 2: Hàm đăng xuất
    function logout() {
      localStorage.removeItem("isAdmin");
      window.location.href = "admin_login.html";
    }

    // BƯỚC 3: URL Apps Script để lấy dữ liệu từ Google Sheets
    const scriptURL = "https://script.google.com/macros/s/AKfycbw_O2bO1bzlk-1s_lpkkrFJARWAra0n6gCBodRMMlVQM9Ve1I4aQZEGCS18vZsltdtO/exec";

    // Hiện thông báo loading
    document.getElementById("loading-message").style.display = "block";
    document.getElementById("results-table").innerHTML = "";

    // BƯỚC 4: Gọi API và hiển thị dữ liệu
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById("loading-message").style.display = "none";
          document.getElementById("results-table").innerHTML = "<p>❌ Không có dữ liệu.</p>";
          return;
        }

        let table = '<table border="1" cellspacing="0" cellpadding="8">';
        table += `
          <tr>
            <th>Họ tên</th>
            <th>Năm sinh</th>
            <th>SĐT phụ huynh</th>
            <th>Kết quả</th>
            <th>Vocab</th>
            <th>Grammar</th>
            <th>Writing</th>
            <th>Ngày</th>
            <th>Note</th>
          </tr>
        `;

        data.forEach(row => {
        table += `
          <tr>
            <td>${row["Họ tên"] || ""}</td>
            <td>${row["Năm sinh"] || ""}</td>
            <td>${row["SĐT phụ huynh"] ? row["SĐT phụ huynh"].toString().padStart(10, "0") : ""}</td>
            <td>${row["Kết quả"] || ""}</td>
            <td>${row["Vocab"] !== undefined && row["Vocab"] !== "" ? row["Vocab"] : "0"}</td>
            <td>${row["Grammar"] !== undefined && row["Grammar"] !== "" ? row["Grammar"] : "0"}</td>
            <td>${row["Writing"] !== undefined && row["Writing"] !== "" ? row["Writing"] : "0"}</td>
            <td>${formatDate(row["Ngày"])}</td>
            <td>${(row["Note"] || "").split('"').map(s => s.trim()).filter(s => s.length).join('<br><br>')}</td>

          </tr>
        `;
      });


        table += '</table>';
        document.getElementById("results-table").innerHTML = table;

        // Ẩn thông báo loading sau khi hoàn tất
        document.getElementById("loading-message").style.display = "none";
      })
      .catch(err => {
        document.getElementById("loading-message").style.display = "none";
        console.error("❌ Lỗi khi tải dữ liệu:", err);
        document.getElementById("results-table").innerHTML = "<p>❌ Lỗi khi tải dữ liệu.</p>";
      });

    // Hàm định dạng ngày giờ
    function formatDate(dateStr) {
      if (!dateStr) return "";

      const date = new Date(dateStr);
      const options = {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Ho_Chi_Minh'
      };

      return new Intl.DateTimeFormat('vi-VN', options).format(date);
    }
  </script>

</body>
</html>
