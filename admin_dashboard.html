<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/all.css">
</head>
<body>

  <div class="container">
    <div class="header-centered">
      <img src="image/logolv.jpg" alt="Logo" class="logo-absolute">
      <h1>ğŸ“Š Káº¿t quáº£ bÃ i thi</h1>
    </div>

    <div id="loading-message">â³ Äang táº£i dá»¯ liá»‡u, vui lÃ²ng Ä‘á»£i...</div>

    <div id="results-table"></div>

    <div id="admin-content">
      <div id="results-table"></div>
      <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
    </div>
  </div>

  <script>
    // BÆ¯á»šC 1: Kiá»ƒm tra quyá»n admin
    if (localStorage.getItem("isAdmin") !== "true") {
      alert("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ truy cáº­p.");
      window.location.href = "admin_login.html";
    }

    // BÆ¯á»šC 2: HÃ m Ä‘Äƒng xuáº¥t
    function logout() {
      localStorage.removeItem("isAdmin");
      window.location.href = "admin_login.html";
    }

    // BÆ¯á»šC 3: URL Apps Script Ä‘á»ƒ láº¥y dá»¯ liá»‡u tá»« Google Sheets
    const scriptURL = "https://script.google.com/macros/s/AKfycbw_O2bO1bzlk-1s_lpkkrFJARWAra0n6gCBodRMMlVQM9Ve1I4aQZEGCS18vZsltdtO/exec";

    // Hiá»‡n thÃ´ng bÃ¡o loading
    document.getElementById("loading-message").style.display = "block";
    document.getElementById("results-table").innerHTML = "";

    // BÆ¯á»šC 4: Gá»i API vÃ  hiá»ƒn thá»‹ dá»¯ liá»‡u
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById("loading-message").style.display = "none";
          document.getElementById("results-table").innerHTML = "<p>âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u.</p>";
          return;
        }

        let table = '<table border="1" cellspacing="0" cellpadding="8">';
        table += `
          <tr>
            <th>Há» tÃªn</th>
            <th>NÄƒm sinh</th>
            <th>SÄT phá»¥ huynh</th>
            <th>Káº¿t quáº£</th>
            <th>Vocab</th>
            <th>Grammar</th>
            <th>Writing</th>
            <th>NgÃ y</th>
            <th>Note</th>
          </tr>
        `;

        data.forEach(row => {
        table += `
          <tr>
            <td>${row["Há» tÃªn"] || ""}</td>
            <td>${row["NÄƒm sinh"] || ""}</td>
            <td>${row["SÄT phá»¥ huynh"] ? row["SÄT phá»¥ huynh"].toString().padStart(10, "0") : ""}</td>
            <td>${row["Káº¿t quáº£"] || ""}</td>
            <td>${row["Vocab"] !== undefined && row["Vocab"] !== "" ? row["Vocab"] : "0"}</td>
            <td>${row["Grammar"] !== undefined && row["Grammar"] !== "" ? row["Grammar"] : "0"}</td>
            <td>${row["Writing"] !== undefined && row["Writing"] !== "" ? row["Writing"] : "0"}</td>
            <td>${formatDate(row["NgÃ y"])}</td>
            <td>${(row["Note"] || "").split('"').map(s => s.trim()).filter(s => s.length).join('<br><br>')}</td>

          </tr>
        `;
      });


        table += '</table>';
        document.getElementById("results-table").innerHTML = table;

        // áº¨n thÃ´ng bÃ¡o loading sau khi hoÃ n táº¥t
        document.getElementById("loading-message").style.display = "none";
      })
      .catch(err => {
        document.getElementById("loading-message").style.display = "none";
        console.error("âŒ Lá»—i khi táº£i dá»¯ liá»‡u:", err);
        document.getElementById("results-table").innerHTML = "<p>âŒ Lá»—i khi táº£i dá»¯ liá»‡u.</p>";
      });

    // HÃ m Ä‘á»‹nh dáº¡ng ngÃ y giá»
    function formatDate(dateStr) {
      if (!dateStr) return "";

      const date = new Date(dateStr);
      const options = {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Ho_Chi_Minh'
      };

      return new Intl.DateTimeFormat('vi-VN', options).format(date);
    }
  </script>

</body>
</html>
